# 검색 방식 정리 (2026-02-23)

## 1. 인덱스 구축 (서버 시작 시 1회)

`ensureIndex()` 에서 실행

```
experiments 테이블
    + projects 테이블 (LEFT JOIN)
    + split_tables (각 실험별 조회)
        → 문서 배열 생성 → TF-IDF 인덱스 빌드
```

각 문서는 실험 필드 + 과제 필드 + 스플릿 필드를 하나의 텍스트로 합침.
중요도 높은 필드(`iacpj_ta_goa`, `iacpj_cur_stt`)는 **2~3번 반복**해서 가중치 효과를 냄.

---

## 2. 토크나이징

- 소문자 변환
- 한글/영문/숫자 경계에 자동 공백 삽입 (`"dishing을"` → `"dishing 을"`)
- 특수문자 제거
- 공백으로 분리 → 토큰 배열

---

## 3. TF-IDF 점수 계산

- **TF** (Term Frequency): 이 문서에서 단어가 얼마나 자주 나왔나 (정규화)
- **IDF** (Inverse Document Frequency): 전체 문서 중 이 단어가 희귀할수록 높음
- `score = TF × IDF` 로 각 문서가 벡터화됨

검색 시 쿼리도 동일하게 벡터화하고 **코사인 유사도**로 모든 문서와 비교 → 점수 높은 순 정렬

---

## 4. 검색 실행 - 2가지 경로

### 경로 A: 따옴표 검색 (`"정확한문구"`)

예시: `"산화막" 두께` → quotedTerms: ["산화막"], normalQuery: "두께"

1. **전체 문서 풀스캔** → 따옴표 문구가 substring으로 정확히 포함된 문서만 필터
2. normalQuery가 있으면 그 결과를 TF-IDF 점수로 정렬
3. 없으면 score=1로 반환

### 경로 B: 일반 키워드 검색

예시: `산화막 두께`

1. TF-IDF로 상위 topK개 후보 추출
2. **AND 필터**: 모든 토큰이 문서에 포함된 것만 남김
3. AND 필터 결과 0건이면 → **TF-IDF 결과 그대로 폴백**
   - "모든 단어가 정확히 포함된 문서가 없으면, 관련성 높은 순으로 보여줌"

---

## 5. 추천 키워드 생성

검색 결과 내에서 "이 키워드를 추가하면 결과가 의미있게 줄어드는" 것만 추천:

| 조건 | 처리 |
|------|------|
| 결과 전체에 다 있는 키워드 | 제외 (필터 효과 없음) |
| 결과가 0건이 되는 키워드 | 제외 (너무 좁아짐) |
| 결과 6건↑ 인데 1건에만 있는 키워드 | 제외 (너무 세부적) |
| 결과를 50:50으로 나누는 키워드 | 구분력 점수 최高 |

상위 6개, 다양한 필드에서 고르게 선택해서 반환

---

## 전체 흐름 요약

```
검색어 입력
    ↓
parseQuery() → 따옴표/일반 분리
    ↓
┌── 따옴표 있음 ──→ 풀스캔 + substring 매칭 → TF-IDF 정렬
│
└── 일반 검색 ──→ TF-IDF topK → AND 필터 → (0건이면 폴백)
    ↓
결과 enrichment (splits, project 데이터 조인)
    ↓
summary 텍스트 생성 + 추천 키워드 생성
    ↓
{ summary, suggestions, results } 반환
```
